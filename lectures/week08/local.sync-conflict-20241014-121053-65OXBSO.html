<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Geography 385: Spatial Data Analysis - Local Spatial Autocorrelation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles/custom.scss">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Geography 385: Spatial Data Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-lectures" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Lectures</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-lectures">    
        <li>
    <a class="dropdown-item" href="../../lectures/week01/index.html">
 <span class="dropdown-text">08-26 Course Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../lectures/week01/lecture_sda.html">
 <span class="dropdown-text">09-09 Spatial Data Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../lectures/week04/lecture_area.html">
 <span class="dropdown-text">09-16 Area Unit Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../lectures/week05/choro.html">
 <span class="dropdown-text">09-23 Choropleth Maps</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../lectures/week06/spatial_weights.html">
 <span class="dropdown-text">09-30 Spatial Weights</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../lectures/week07/global.html">
 <span class="dropdown-text">10-07 Global Spatial Autocorrelation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../lectures/week08/local.html">
 <span class="dropdown-text">10-14 Local Spatial Autocorrelation</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-studio" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Studio</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-studio">    
        <li>
    <a class="dropdown-item" href="../../studio/week01/index.html">
 <span class="dropdown-text">08-28 Studio 1: Juptyer Hub Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../studio/week02/index.html">
 <span class="dropdown-text">09-04 Studio 2: Pandas</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../studio/week03/index.html">
 <span class="dropdown-text">09-11 Studio 3: GeoPandas</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../studio/week04/index.html">
 <span class="dropdown-text">09-18 Studio 4: GeoProcessing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../studio/week05/index.html">
 <span class="dropdown-text">09-25 Studio 5: Choropleth Mapping</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../studio/week06/peer1.html">
 <span class="dropdown-text">10-02 Studio 6: Peer Evaluation 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../studio/week07/global.html">
 <span class="dropdown-text">10-09 Studio 7: Global Spatial Autocorrelation</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link active" href="../../studio/week08/local.html" aria-current="page"> 
<span class="menu-text">10-16 Studio 8: Local Spatial Autocorrelation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../references.html"> 
<span class="menu-text">References</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../lectures/week08/local.html">10-14 Local Spatial Autocorrelation</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/week01/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">08-26 Course Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../studio/week01/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">08-28 Studio 1: Jupyter Hub</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../studio/week02/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">09-04 Studio 2: Pandas</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/week03/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">09-09 Spatial Data Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../studio/week03/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">09-11 Studio 3: GeoPandas</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/week04/lecture_area.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">09-16 Area Unit Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../studio/week04/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">09-18 Studio 4: Geosnap and Geoprocessing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/week05/choro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">09-23 Choropleth Mapping</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../studio/week05/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">09-25 Studio 5: Choropleth Mapping</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/week06/spatial_weights.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">09-30 Spatial Weights</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../studio/week06/peer1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10-02 Studio 6: Peer Evaluation 1</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/week07/global.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10-07 Global Spatial Autocorrelation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../studio/week07/global.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10-09 Studio 7: Global Spatial Autocorrelation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/week08/local.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">10-14 Local Spatial Autocorrelation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../studio/week08/local.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10-16 Studio 8: Local Spatial Autocorrelation</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#imports" id="toc-imports" class="nav-link active" data-scroll-target="#imports">Imports</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a>
  <ul class="collapse">
  <li><a href="#census-polygons" id="toc-census-polygons" class="nav-link" data-scroll-target="#census-polygons">Census Polygons</a></li>
  </ul></li>
  <li><a href="#global-spatial-autocorrelation" id="toc-global-spatial-autocorrelation" class="nav-link" data-scroll-target="#global-spatial-autocorrelation">Global Spatial Autocorrelation</a>
  <ul class="collapse">
  <li><a href="#spatial-similarity" id="toc-spatial-similarity" class="nav-link" data-scroll-target="#spatial-similarity">Spatial Similarity</a></li>
  <li><a href="#attribute-similarity" id="toc-attribute-similarity" class="nav-link" data-scroll-target="#attribute-similarity">Attribute Similarity</a></li>
  <li><a href="#testing-for-global-spatial-autocorrelation" id="toc-testing-for-global-spatial-autocorrelation" class="nav-link" data-scroll-target="#testing-for-global-spatial-autocorrelation">Testing for Global Spatial Autocorrelation</a></li>
  </ul></li>
  <li><a href="#local-autocorrelation-hot-spots-cold-spots-and-spatial-outliers" id="toc-local-autocorrelation-hot-spots-cold-spots-and-spatial-outliers" class="nav-link" data-scroll-target="#local-autocorrelation-hot-spots-cold-spots-and-spatial-outliers">Local Autocorrelation: Hot Spots, Cold Spots, and Spatial Outliers</a>
  <ul class="collapse">
  <li><a href="#hot-spots" id="toc-hot-spots" class="nav-link" data-scroll-target="#hot-spots">Hot Spots</a></li>
  <li><a href="#cold-spots" id="toc-cold-spots" class="nav-link" data-scroll-target="#cold-spots">Cold Spots</a></li>
  <li><a href="#spatial-outliers" id="toc-spatial-outliers" class="nav-link" data-scroll-target="#spatial-outliers">Spatial Outliers</a></li>
  <li><a href="#cluster-map" id="toc-cluster-map" class="nav-link" data-scroll-target="#cluster-map">Cluster Map</a></li>
  <li><a href="#a-note-on-spatial-clusters" id="toc-a-note-on-spatial-clusters" class="nav-link" data-scroll-target="#a-note-on-spatial-clusters">A note on spatial clusters</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Local Spatial Autocorrelation</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In today’s lecture, we will delve into the concept of <strong>local spatial autocorrelation</strong>, an essential tool in geographic data science that allows us to explore spatial patterns at a more granular level. While global measures like Moran’s I provide an overall summary of spatial autocorrelation across an entire region, local spatial autocorrelation helps identify specific areas where values cluster or where unusual spatial patterns emerge. By examining local indicators of spatial association (LISA), we can detect hotspots, cold spots, and outliers, which are critical for understanding localized spatial phenomena. This approach is particularly valuable in fields like public health, urban studies, and environmental monitoring, where localized insights can inform targeted interventions.</p>
<p>We first review the basics of <em>global spatial autocorrelation&amp; and then take a deeper dive into </em>local spatial autocorrelation*.</p>
<section id="imports" class="level2">
<h2 class="anchored" data-anchor-id="imports">Imports</h2>
<div id="a5e51f23" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> esda</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> libpysal <span class="im">as</span> lps</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> contextily <span class="im">as</span> cx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="49cb3245" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sns.set_context(<span class="st">'notebook'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(<span class="st">"ignore"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<p>For this exercise, we’ll use two datasets:</p>
<ol type="1">
<li>a set of polygons (census tracts) for the city of San Diego from the US Census American Community Survey 5-year estimates.</li>
</ol>
<section id="census-polygons" class="level3">
<h3 class="anchored" data-anchor-id="census-polygons">Census Polygons</h3>
<div id="8f507366" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>scag <span class="op">=</span> gpd.read_parquet(<span class="st">"~/data/scag_region.parquet"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="511e1a41" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>san_diego <span class="op">=</span> scag[scag.geoid.<span class="bu">str</span>[:<span class="dv">5</span>]<span class="op">==</span><span class="st">'06073'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="463e332d" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>san_diego.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'geopandas.geodataframe.GeoDataFrame'&gt;
Index: 627 entries, 158 to 4567
Columns: 194 entries, geoid to geometry
dtypes: float64(191), geometry(1), int64(1), object(1)
memory usage: 955.2+ KB</code></pre>
</div>
</div>
<div id="c3d873a3" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>san_diego <span class="op">=</span> san_diego.dropna(subset<span class="op">=</span>[<span class="st">'median_home_value'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a242c70f" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>san_diego <span class="op">=</span> san_diego.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b17c9232" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>f, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>san_diego.plot(<span class="st">'median_home_value'</span>, ax<span class="op">=</span>ax, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax, crs<span class="op">=</span>san_diego.crs.to_string(), source<span class="op">=</span>cx.providers.CartoDB.Positron)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">'off'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="local_files/figure-html/cell-9-output-1.png" width="763" height="588" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="59202983" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>san_diego.median_home_value.hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="local_files/figure-html/cell-10-output-1.png" width="581" height="434" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="4b789483" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">12</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>san_diego.dropna(subset<span class="op">=</span>[<span class="st">'median_home_value'</span>]).to_crs(epsg<span class="op">=</span><span class="dv">3857</span>).plot(<span class="st">'median_home_value'</span>, legend<span class="op">=</span><span class="va">True</span>, scheme<span class="op">=</span><span class="st">'quantiles'</span>, cmap<span class="op">=</span><span class="st">'GnBu'</span>, k<span class="op">=</span><span class="dv">5</span>, ax<span class="op">=</span>ax, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax, crs<span class="op">=</span>san_diego.crs.to_string(), source<span class="op">=</span>cx.providers.CartoDB.Positron)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">'off'</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Median Home Value (Quintiles)"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="local_files/figure-html/cell-11-output-1.png" width="1137" height="898" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="global-spatial-autocorrelation" class="level2">
<h2 class="anchored" data-anchor-id="global-spatial-autocorrelation">Global Spatial Autocorrelation</h2>
<p>Visual inspection of the map pattern for the prices allows us to search for spatial structure. If the spatial distribution of the prices was random, then we should not see any clustering of similar values on the map. However, our visual system is drawn to the darker clusters along the coast, and a concentration of the lighter hues (lower prices) in the north central and south east. In the point data, the trees are too dense to make any sense of the pattern</p>
<p>Our brains are very powerful pattern recognition machines. However, sometimes they can be too powerful and lead us to detect false positives, or patterns where there are no statistical patterns. This is a particular concern when dealing with visualization of irregular polygons of differning sizes and shapes.</p>
<p>The concept of <em>spatial autocorrelation</em> relates to the combination of two types of similarity: spatial similarity and attribute similarity. Although there are many different measures of spatial autocorrelation, they all combine these two types of simmilarity into a summary measure.</p>
<p>Let’s use PySAL to generate these two types of similarity measures.</p>
<section id="spatial-similarity" class="level3">
<h3 class="anchored" data-anchor-id="spatial-similarity">Spatial Similarity</h3>
<p>We have already encountered spatial weights in a previous notebook. In spatial autocorrelation analysis, the spatial weights are used to formalize the notion of spatial similarity. As we have seen there are many ways to define spatial weights, here we will use queen contiguity:</p>
<div id="20f6e198" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>wq <span class="op">=</span>  lps.weights.Queen.from_dataframe(san_diego)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>wq.transform <span class="op">=</span> <span class="st">'r'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="attribute-similarity" class="level3">
<h3 class="anchored" data-anchor-id="attribute-similarity">Attribute Similarity</h3>
<p>So the spatial weight between neighborhoods <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> indicates if the two are neighbors (i.e., geographically similar). What we also need is a measure of attribute similarity to pair up with this concept of spatial similarity. The <strong>spatial lag</strong> is a derived variable that accomplishes this for us. For neighborhood <span class="math inline">\(i\)</span> the spatial lag is defined as: <span class="math display">\[ylag_i = \sum_j w_{i,j} y_j\]</span></p>
<div id="cc2f8f54" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> san_diego[<span class="st">'median_home_value'</span>]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ylag <span class="op">=</span> lps.weights.lag_spatial(wq, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6a1872e4" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>f, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">12</span>))</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>san_diego.assign(cl<span class="op">=</span>ylag).plot(column<span class="op">=</span><span class="st">'cl'</span>, scheme<span class="op">=</span><span class="st">'quantiles'</span>, <span class="op">\</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>        k<span class="op">=</span><span class="dv">5</span>, cmap<span class="op">=</span><span class="st">'GnBu'</span>, linewidth<span class="op">=</span><span class="fl">0.1</span>, ax<span class="op">=</span>ax, <span class="op">\</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        edgecolor<span class="op">=</span><span class="st">'white'</span>, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax, crs<span class="op">=</span>san_diego.crs.to_string(), source<span class="op">=</span>cx.providers.CartoDB.Positron)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">'off'</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Spatial Lag Median Home Val (Quintiles)"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="local_files/figure-html/cell-14-output-1.png" width="912" height="726" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The quintile map for the spatial lag tends to enhance the impression of value similarity in space. It is, in effect, a local smoother.</p>
<div id="fa858dfe" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>san_diego[<span class="st">'lag_median_pri'</span>] <span class="op">=</span> ylag</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>f,ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>,figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>san_diego.plot(column<span class="op">=</span><span class="st">'median_home_value'</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>],</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        scheme<span class="op">=</span><span class="st">"quantiles"</span>,  k<span class="op">=</span><span class="dv">5</span>, cmap<span class="op">=</span><span class="st">'GnBu'</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">#ax[0].axis(san_diego.total_bounds[np.asarray([0,2,1,3])])</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Price"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>san_diego.plot(column<span class="op">=</span><span class="st">'lag_median_pri'</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>],</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        scheme<span class="op">=</span><span class="st">'quantiles'</span>, cmap<span class="op">=</span><span class="st">'GnBu'</span>, k<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax[<span class="dv">0</span>], crs<span class="op">=</span>san_diego.crs.to_string(), source<span class="op">=</span>cx.providers.CartoDB.Positron)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax[<span class="dv">1</span>], crs<span class="op">=</span>san_diego.crs.to_string(), source<span class="op">=</span>cx.providers.CartoDB.Positron)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Spatial Lag Price"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="local_files/figure-html/cell-15-output-1.png" width="893" height="340" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>However, we still have the challenge of visually associating the value of the prices in a neighborhod with the value of the spatial lag of values for the focal unit. The latter is a weighted average of home prices in the focal county’s neighborhood.</p>
<p>To complement the geovisualization of these associations we can turn to formal statistical measures of spatial autocorrelation.</p>
</section>
<section id="testing-for-global-spatial-autocorrelation" class="level3">
<h3 class="anchored" data-anchor-id="testing-for-global-spatial-autocorrelation">Testing for Global Spatial Autocorrelation</h3>
<section id="join-counts" class="level4">
<h4 class="anchored" data-anchor-id="join-counts">Join counts</h4>
<p>One way to formalize a test for spatial autocorrelation in a binary attribute is to consider the so-called <em>joins</em>. A join exists for each neighbor pair of observations, and the joins are reflected in our binary spatial weights object <code>wq</code>.</p>
<p>Each unit can take on one of two values “Black” or “White”, analogous to the layout of a chessboard</p>
<div id="ade31d76" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>nrows, ncols <span class="op">=</span> <span class="dv">9</span>,<span class="dv">9</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>image <span class="op">=</span> np.zeros(nrows<span class="op">*</span>ncols)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set every other cell to 1</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>image[::<span class="dv">2</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape things into a 9x9 grid.</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>image <span class="op">=</span> image.reshape((nrows, ncols))</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>plt.matshow(image, cmap<span class="op">=</span><span class="st">'Greys'</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="local_files/figure-html/cell-16-output-1.png" width="391" height="391" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>and so for a given pair of neighboring locations there are three different types of joins that can arise:</p>
<ul>
<li>Black Black (BB)</li>
<li>White White (WW)</li>
<li>Black White (or White Black) (BW)</li>
</ul>
<p>We can use the <code>esda</code> package from PySAL to carry out join count analysis. In the case of our point data, the join counts can help us determine whether different varieties of trees tend to grow together, spread randomly through space, or compete with one another for precious resources</p>
</section>
<section id="polygon-data" class="level4">
<h4 class="anchored" data-anchor-id="polygon-data">Polygon Data</h4>
<p>With polygon data, we can conduct an analysis using a contiguity matrix. For our housing price data, we need to first discretize the variable we’re using; to keep things simple, we’ll binarize our price data using the median so that “high” values are tracts whose median home price is above the city’s median and “low” values are those below</p>
<div id="fb0e1e31" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>y.median()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>405416.57303370786</code></pre>
</div>
</div>
<div id="d1ee8a5f" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>san_diego.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>(627, 195)</code></pre>
</div>
</div>
<div id="5f03f9de" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>yb <span class="op">=</span> y <span class="op">&gt;</span> y.median()</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="bu">sum</span>(yb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>313</code></pre>
</div>
</div>
<div id="70b27c29" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>yb <span class="op">=</span> y <span class="op">&gt;</span> y.median()</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">"0 Low"</span>, <span class="st">"1 High"</span>]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>yb <span class="op">=</span> [labels[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">1</span><span class="op">*</span>yb] </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>san_diego[<span class="st">'yb'</span>] <span class="op">=</span> yb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="75aa14b3" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">12</span>))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>san_diego.plot(column<span class="op">=</span><span class="st">'yb'</span>, cmap<span class="op">=</span><span class="st">'binary'</span>, edgecolor<span class="op">=</span><span class="st">'grey'</span>, legend<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>ax)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="local_files/figure-html/cell-21-output-1.png" width="957" height="763" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The spatial distribution of the binary variable immediately raises questions about the juxtaposition of the “black” and “white” areas.</p>
<p>Given that we have 308 Black polygons on our map, what is the number of Black Black (BB) joins we could expect if the process were such that the Black polygons were randomly assigned on the map?</p>
<div id="50edf4e7" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>yb <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> (y <span class="op">&gt;</span> y.median()) <span class="co"># convert back to binary</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>wq <span class="op">=</span>  lps.weights.Queen.from_dataframe(san_diego)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>wq.transform <span class="op">=</span> <span class="st">'b'</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">12345</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>jc <span class="op">=</span> esda.join_counts.Join_Counts(yb, wq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting object stores the observed counts for the different types of joins:</p>
<div id="be950b15" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>jc.bb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>754.0</code></pre>
</div>
</div>
<div id="3e719027" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>jc.ww</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>745.0</code></pre>
</div>
</div>
<div id="c0b93b73" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>jc.bw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>475.0</code></pre>
</div>
</div>
<p>Note that the three cases exhaust all possibilities:</p>
<div id="3c05589c" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>jc.bb <span class="op">+</span> jc.ww <span class="op">+</span> jc.bw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>1974.0</code></pre>
</div>
</div>
<p>and</p>
<div id="7b26e933" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>wq.s0 <span class="op">/</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>1974.0</code></pre>
</div>
</div>
<p>which is the unique number of joins in the spatial weights object.</p>
<p>Our object tells us we have observed 736 BB joins:</p>
<div id="db79ef21" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>jc.bb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>754.0</code></pre>
</div>
</div>
<p>The critical question for us, is whether this is a departure from what we would expect if the process generating the spatial distribution of the Black polygons were a completely random one? To answer this, PySAL uses random spatial permutations of the observed attribute values to generate a realization under the null of <em>complete spatial randomness</em> (CSR). This is repeated a large number of times (999 default) to construct a reference distribution to evaluate the statistical significance of our observed counts.</p>
<p>The average number of BB joins from the synthetic realizations is:</p>
<div id="8ee49e8d" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>jc.mean_bb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>490.03103103103103</code></pre>
</div>
</div>
<p>which is less than our observed count. The question is whether our observed value is so different from the expectation that we would reject the null of CSR?</p>
<div id="fc7106d4" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sbn</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>sbn.kdeplot(jc.sim_bb, shade<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>plt.vlines(jc.bb, <span class="dv">0</span>, <span class="fl">0.005</span>, color<span class="op">=</span><span class="st">'r'</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>plt.vlines(jc.mean_bb, <span class="dv">0</span>,<span class="fl">0.005</span>)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'BB Counts'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>Text(0.5, 0, 'BB Counts')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="local_files/figure-html/cell-30-output-2.png" width="615" height="437" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The density portrays the distribution of the BB counts, with the black vertical line indicating the mean BB count from the synthetic realizations and the red line the observed BB count for our prices. Clearly our observed value is extremely high. A pseudo p-value summarizes this:</p>
<div id="e8da5e55" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>jc.p_sim_bb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>0.001</code></pre>
</div>
</div>
<p>Since this is below conventional significance levels, we would reject the null of complete spatial randomness in favor of spatial autocorrelation in market prices.</p>
</section>
<section id="continuous-case" class="level4">
<h4 class="anchored" data-anchor-id="continuous-case">Continuous Case</h4>
<p>The join count analysis is based on a binary attribute, which can cover many interesting empirical applications where one is interested in presence and absence type phenomena. In our case, we artificially created the binary variable, and in the process we throw away a lot of information in our originally continuous attribute. Turning back to the original variable, we can explore other tests for spatial autocorrelation for the continuous case.</p>
<p>First, we transform our weights to be row-standardized, from the current binary state:</p>
<div id="0c9195a8" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>wq.transform <span class="op">=</span> <span class="st">'r'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="352ee9f3" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> san_diego[<span class="st">'median_home_value'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Moran’s I is a test for global autocorrelation for a continuous attribute:</p>
<div id="2dda9d90" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">12345</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>mi <span class="op">=</span> esda.moran.Moran(y, wq)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>mi.I</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>0.660917168991019</code></pre>
</div>
</div>
<p>Again, our value for the statistic needs to be interpreted against a reference distribution under the null of CSR. PySAL uses a similar approach as we saw in the join count analysis: random spatial permutations.</p>
<div id="7ae4eab5" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> splot.esda <span class="im">import</span> plot_moran</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>plot_moran(mi, zstandard<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">4</span>))</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="local_files/figure-html/cell-35-output-1.png" width="832" height="398" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="73f24e46" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>mi.p_sim</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>0.001</code></pre>
</div>
</div>
<p>On the left, we have the reference distribution versus the observed statistic; on the right, we have a plot of the focal value against its spatial lag, for which the Moran I statistic serves as the slope</p>
<p>Here our observed value is again in the upper tail</p>
<div id="42952e60" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>mi.p_sim</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>0.001</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="local-autocorrelation-hot-spots-cold-spots-and-spatial-outliers" class="level2">
<h2 class="anchored" data-anchor-id="local-autocorrelation-hot-spots-cold-spots-and-spatial-outliers">Local Autocorrelation: Hot Spots, Cold Spots, and Spatial Outliers</h2>
<p>Local autocorrelation statistics provide indications of spatial autocorrelation in a subset of the data. With <span class="math inline">\(n\)</span> observations, there are <span class="math inline">\(n\)</span> such subsets, with each subset consisting of a <em>focal</em> unit together with the <em>neighbors</em> of the focal unit.</p>
<p>PySAL has many local autocorrelation statistics. Let’s compute a local Moran statistic for the same data</p>
<div id="a27233d0" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">12345</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="25fd450d" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>wq.transform <span class="op">=</span> <span class="st">'r'</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>lag_price <span class="op">=</span> lps.weights.lag_spatial(wq, san_diego[<span class="st">'median_home_value'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4de2bce6" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>li <span class="op">=</span> esda.moran.Moran_Local(y, wq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, instead of a single <span class="math inline">\(I\)</span> statistic, we have an <em>array</em> of local <span class="math inline">\(I_i\)</span> statistics, stored in the <code>.Is</code> attribute, and p-values from the simulation are in <code>p_sim</code>.</p>
<div id="c6c740e3" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> splot.esda <span class="im">import</span> moran_scatterplot</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> moran_scatterplot(li)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Price'</span>)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Spatial Lag of Price'</span>)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="local_files/figure-html/cell-41-output-1.png" width="621" height="585" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can again test for local clustering using permutations, but here we use conditional random permutations (different distributions for each focal location)</p>
<div id="fa896e7d" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>(li.p_sim <span class="op">&lt;</span> <span class="fl">0.05</span>).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>246</code></pre>
</div>
</div>
<div id="71166b85" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> moran_scatterplot(li, p<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Price'</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Spatial Lag of Price'</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="local_files/figure-html/cell-43-output-1.png" width="621" height="585" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can distinguish the specific type of local spatial association reflected in the four quadrants of the Moran Scatterplot above: - High-High (upper right) - Low-Low (bottom left) - High-Low (lower right) - Low-High (upper left)</p>
<p>This information is encoded in the <code>q</code> attribution of the Local Moran object:</p>
<div id="46bb9228" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>li.q</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>array([4, 1, 2, 3, 3, 3, 3, 4, 3, 3, 1, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,
       3, 2, 3, 2, 2, 1, 1, 2, 3, 3, 3, 3, 3, 2, 1, 3, 3, 3, 2, 1, 1, 1,
       3, 1, 3, 3, 4, 3, 1, 1, 3, 3, 3, 1, 3, 3, 1, 3, 3, 3, 3, 3, 1, 2,
       2, 1, 2, 4, 3, 3, 4, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 3, 3, 3, 1, 1,
       3, 3, 2, 2, 2, 1, 4, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 3, 3, 2,
       2, 4, 3, 3, 1, 3, 3, 3, 3, 1, 1, 3, 3, 3, 3, 1, 3, 3, 1, 1, 1, 3,
       1, 3, 3, 3, 1, 1, 3, 3, 3, 1, 1, 3, 3, 3, 3, 1, 3, 3, 1, 3, 3, 1,
       1, 3, 3, 3, 3, 1, 1, 3, 3, 4, 3, 3, 3, 3, 3, 3, 3, 3, 1, 3, 1, 1,
       1, 1, 1, 2, 1, 2, 1, 1, 2, 1, 3, 3, 2, 3, 4, 4, 2, 3, 3, 3, 3, 3,
       3, 3, 3, 3, 3, 1, 3, 3, 2, 1, 1, 2, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1,
       1, 1, 3, 3, 3, 4, 1, 3, 3, 1, 2, 4, 3, 3, 3, 3, 3, 3, 1, 2, 3, 2,
       2, 2, 3, 3, 3, 3, 3, 3, 1, 1, 1, 2, 4, 3, 3, 1, 3, 3, 3, 3, 3, 1,
       3, 3, 3, 2, 1, 1, 1, 3, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 3, 3, 4,
       1, 1, 1, 1, 3, 1, 3, 4, 4, 4, 3, 2, 1, 1, 2, 3, 3, 2, 3, 4, 3, 3,
       3, 3, 3, 4, 3, 3, 4, 1, 3, 3, 3, 4, 1, 3, 3, 3, 3, 3, 4, 4, 3, 2,
       3, 3, 1, 1, 4, 4, 3, 3, 3, 3, 3, 3, 2, 3, 3, 3, 3, 1, 1, 2, 3, 4,
       1, 1, 3, 3, 1, 3, 3, 3, 2, 3, 3, 3, 4, 3, 1, 3, 3, 2, 1, 2, 3, 3,
       4, 3, 3, 3, 3, 1, 1, 1, 3, 3, 3, 1, 1, 3, 3, 4, 1, 1, 1, 1, 2, 1,
       1, 2, 3, 3, 3, 3, 4, 2, 1, 1, 1, 1, 1, 3, 3, 3, 1, 1, 2, 4, 1, 3,
       3, 3, 2, 1, 2, 3, 3, 3, 3, 3, 3, 2, 3, 3, 3, 4, 2, 1, 1, 3, 3, 1,
       3, 3, 3, 3, 3, 2, 3, 2, 1, 3, 3, 3, 3, 3, 3, 3, 3, 1, 3, 1, 2, 1,
       1, 1, 1, 3, 3, 3, 3, 1, 1, 2, 1, 1, 1, 1, 1, 1, 2, 1, 3, 3, 1, 1,
       1, 1, 3, 1, 3, 3, 2, 3, 1, 1, 3, 3, 3, 3, 4, 2, 1, 1, 1, 2, 3, 1,
       3, 3, 1, 1, 3, 3, 1, 2, 3, 3, 3, 3, 3, 3, 1, 1, 3, 3, 3, 1, 1, 1,
       3, 3, 1, 4, 1, 3, 1, 2, 1, 3, 1, 3, 3, 3, 3, 4, 3, 3, 4, 1, 4, 3,
       3, 3, 3, 2, 3, 1, 1, 4, 1, 1, 1, 1, 3, 3, 1, 3, 3, 2, 2, 3, 2, 4,
       1, 1, 1, 1, 3, 3, 4, 1, 3, 1, 2, 3, 1, 1, 1, 1, 2, 2, 3, 3, 3, 1,
       3, 2, 1, 1, 3, 1, 1, 3, 3, 1, 3, 1, 1, 1, 3, 3, 3, 3, 1, 3, 1, 4,
       4, 3, 3, 3, 3, 3, 1, 3, 4, 3, 3])</code></pre>
</div>
</div>
<section id="hot-spots" class="level3">
<h3 class="anchored" data-anchor-id="hot-spots">Hot Spots</h3>
<p>The local statistic can be used to identify so-called “hot spots”. To be a hot spot, a focal unit has to satisfy two conditions:</p>
<ul>
<li>It is in the High-High quadrant of the Moran Scatter Plot</li>
<li>It has a statistically significant Local Moran</li>
</ul>
<div id="ddf85341" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>hotspot <span class="op">=</span> (li.p_sim <span class="op">&lt;</span> <span class="fl">0.05</span>) <span class="op">*</span> (li.q<span class="op">==</span><span class="dv">1</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span>hotspot<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> hot spots"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 98 hot spots</code></pre>
</div>
</div>
</section>
<section id="cold-spots" class="level3">
<h3 class="anchored" data-anchor-id="cold-spots">Cold Spots</h3>
<p>A second type of positive local spatial autocorrelation occurs in the case of “cold spots”. To be a cold spot, a focal unit has to satisfy two conditions:</p>
<ul>
<li>It is in the Low-Low quadrant of the Moran Scatter Plot</li>
<li>It has a statistically significant Local Moran</li>
</ul>
<div id="5d627970" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>coldspot <span class="op">=</span> (li.p_sim <span class="op">&lt;</span> <span class="fl">0.05</span>) <span class="op">*</span> (li.q<span class="op">==</span><span class="dv">3</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span>coldspot<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> cold spots"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 143 cold spots</code></pre>
</div>
</div>
</section>
<section id="spatial-outliers" class="level3">
<h3 class="anchored" data-anchor-id="spatial-outliers">Spatial Outliers</h3>
<p>While hot spots and cold spots reflect positive local spatial autocorrelation, we know that another departure from spatial randomness can occur: negative spatial autocorrelation. This is when the value dissimilarity between the focal unit and those of its neighbors is larger than what could be due to random chance.</p>
<p>There are two types of spatial outliers.</p>
<p>A doughnut (the kind with a hole) is a spatial outlier where the focal unit is low, but the neighboring values are high. This would place the observation in quadrant 2 of the scatter plot (LH). The position is a necessary, but not sufficient, condition for being classified as a doughnut. The local Moran value must also be statistically significant.</p>
<div id="407ac391" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>doughnut <span class="op">=</span> (li.p_sim <span class="op">&lt;</span> <span class="fl">0.05</span>) <span class="op">*</span> (li.q<span class="op">==</span><span class="dv">2</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span>doughnut<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> doughnuts"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 5 doughnuts</code></pre>
</div>
</div>
<p>The second type of spatial outlier is the “diamond in the rough”. Here the focal value is high, but the neighboring values are low, and the local Moran value is statistically significant:</p>
<div id="b2471d48" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>diamond <span class="op">=</span> (li.p_sim <span class="op">&lt;</span> <span class="fl">0.05</span>) <span class="op">*</span> (li.q<span class="op">==</span><span class="dv">4</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span>diamond<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> diamonds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 0 diamonds</code></pre>
</div>
</div>
<p>In this case, we do not have any diamond observations, despite having</p>
<div id="99080e6f" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>(li.q<span class="op">==</span><span class="dv">4</span>).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>44</code></pre>
</div>
</div>
<p>observations in the HL quadrant of the scatter plot. In other words, all 44 of these observations have local statistics that are not significantly different from their expectation under the null of spatial randomness.</p>
</section>
<section id="cluster-map" class="level3">
<h3 class="anchored" data-anchor-id="cluster-map">Cluster Map</h3>
<p>Using <code>splot</code>, we can also plot these hot spots, cold spots, and spatial outliers on the original geodataframe</p>
<div id="7bf98fe9" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> splot.esda <span class="im">import</span> lisa_cluster</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>lisa_cluster(li, san_diego, p<span class="op">=</span><span class="fl">0.05</span>, figsize <span class="op">=</span> (<span class="dv">9</span>,<span class="dv">9</span>))</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="local_files/figure-html/cell-50-output-1.png" width="689" height="531" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The cluster map displays the locations having a statistically significant LISA value together with a label for the quadrant of the scatter plot. All other locations are colored grey and labeled as “ns” (not significant).</p>
<div id="8cd70b9f" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> splot.esda <span class="im">import</span> plot_local_autocorrelation</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>plot_local_autocorrelation(li, san_diego, <span class="st">'median_home_value'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>(&lt;Figure size 1440x384 with 3 Axes&gt;,
 array([&lt;Axes: title={'center': 'Moran Local Scatterplot'}, xlabel='Attribute', ylabel='Spatial Lag'&gt;,
        &lt;Axes: &gt;, &lt;Axes: &gt;], dtype=object))</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="local_files/figure-html/cell-51-output-2.png" width="1422" height="398" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Recall that we now have <span class="math inline">\(n\)</span> statistics, one for each location. This is in contrast to the case of global autocorrelation where there was one statistic for all <span class="math inline">\(n\)</span> locations. We can thus examine the statistical significance of any location with the local indicators:</p>
<div id="d677fc03" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">12345</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="13e612a2" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>li <span class="op">=</span> esda.moran.Moran_Local(y, wq, keep_simulations<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="19a889af" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>li.p_sim[<span class="dv">626</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>0.001</code></pre>
</div>
</div>
<div id="13cb4672" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>null <span class="op">=</span> li.sim[<span class="dv">626</span>]</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>observed <span class="op">=</span> li.Is[<span class="dv">626</span>]</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sbn</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>sbn.kdeplot(null, shade<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>plt.vlines(observed,<span class="dv">0</span>, <span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'r'</span>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Local I for tract 626"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>Text(0.5, 0, 'Local I for tract 626')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="local_files/figure-html/cell-55-output-2.png" width="597" height="437" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="a-note-on-spatial-clusters" class="level3">
<h3 class="anchored" data-anchor-id="a-note-on-spatial-clusters">A note on spatial clusters</h3>
<p>It is important to note that only the focal units are symbolized on the cluster map. Because the LISA tells us about the spatial association between the value at the focal unit and the values in its neighboring units, the temptation is to include the neighboring values together with the focal unit, if the latter is significant. This would, however, be misleading in the case of a significant focal unit who had neighbors, some of which had LISA values that were not significant.</p>
<p>Instead, the focal unit with a significant LISA forms the seed of a cluster. When it is contiguous to a different focal unit with a significant LISA of the same form, the cluster will consist of multiple spatial units. Such a connected component is a spatial cluster in the fullest sense.</p>
<!-- ```{python} -->
<!-- cluster_type = hotspot * 1 + doughnut * 2 + coldspot * 3 + diamond * 4 -->
<!-- san_diego['cluster_type'] = cluster_type -->
<!-- import libpysal -->
<!-- print(libpysal.__version__) -->
<!-- g = libpysal.graph.Graph.build_block_contiguity(san_diego.cluster_type) -->
<!-- print(san_diego.shape, g.n) -->
<!-- g.plot(san_diego) -->
<!-- ``` -->
<!-- ```{python} -->
<!-- gq = libpysal.graph.Graph.build_contiguity(san_diego) -->
<!-- gq.plot(san_diego) -->
<!-- ``` -->
<!-- ```{python} -->
<!-- import networkx -->
<!-- gnx = g.to_networkx() -->
<!-- gqnx = g.to_networkx() -->
<!-- inx = networkx.intersection(gnx, gqnx) -->
<!-- cc = networkx.connected_components(inx) -->
<!-- for i, component in enumerate(list(cc)): -->
<!--     print(i, component) -->
<!-- ``` -->
<!-- ```{python} -->
<!-- li.Is.shape -->
<!-- ``` -->
<!-- ```{python} -->
<!-- dir(li) -->
<!-- ``` -->
<!-- ```{python} -->
<!-- dir(li) -->
<!-- ``` -->
<!-- ```{python} -->
<!-- li.rlisas.shape -->
<!-- ``` -->
<!-- ```{python} -->
<!-- li.rlisas[sig[0][-1],:] -->
<!-- ``` -->
<!-- ```{python} -->
<!-- sig[0][-1] -->
<!-- ``` -->
<!-- ```{python} -->
<!-- li.Is[626] -->
<!-- ``` -->


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb81" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Local Spatial Autocorrelation</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> python3</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="co">  cache: true  # Enables caching for the entire document</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>In today's lecture, we will delve into the concept of **local spatial autocorrelation**, an essential tool in geographic data science that allows us to explore spatial patterns at a more granular level. While global measures like Moran’s I provide an overall summary of spatial autocorrelation across an entire region, local spatial autocorrelation helps identify specific areas where values cluster or where unusual spatial patterns emerge. By examining local indicators of spatial association (LISA), we can detect hotspots, cold spots, and outliers, which are critical for understanding localized spatial phenomena. This approach is particularly valuable in fields like public health, urban studies, and environmental monitoring, where localized insights can inform targeted interventions.</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>We first review the basics of *global spatial autocorrelation&amp; and then take a deeper dive into *local spatial autocorrelation*.</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a><span class="fu">## Imports</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> esda</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> libpysal <span class="im">as</span> lps</span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> contextily <span class="im">as</span> cx</span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>sns.set_context(<span class="st">'notebook'</span>)</span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(<span class="st">"ignore"</span>)</span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data</span></span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a>For this exercise, we'll use two datasets:</span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>a set of polygons (census tracts) for the city of San Diego from the US Census American Community Survey 5-year estimates.</span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a><span class="fu">### Census Polygons</span></span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-51"><a href="#cb81-51" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-52"><a href="#cb81-52" aria-hidden="true" tabindex="-1"></a>scag <span class="op">=</span> gpd.read_parquet(<span class="st">"~/data/scag_region.parquet"</span>)</span>
<span id="cb81-53"><a href="#cb81-53" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-54"><a href="#cb81-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-57"><a href="#cb81-57" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-58"><a href="#cb81-58" aria-hidden="true" tabindex="-1"></a>san_diego <span class="op">=</span> scag[scag.geoid.<span class="bu">str</span>[:<span class="dv">5</span>]<span class="op">==</span><span class="st">'06073'</span>]</span>
<span id="cb81-59"><a href="#cb81-59" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-60"><a href="#cb81-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-63"><a href="#cb81-63" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-64"><a href="#cb81-64" aria-hidden="true" tabindex="-1"></a>san_diego.info()</span>
<span id="cb81-65"><a href="#cb81-65" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-66"><a href="#cb81-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-69"><a href="#cb81-69" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-70"><a href="#cb81-70" aria-hidden="true" tabindex="-1"></a>san_diego <span class="op">=</span> san_diego.dropna(subset<span class="op">=</span>[<span class="st">'median_home_value'</span>])</span>
<span id="cb81-71"><a href="#cb81-71" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-72"><a href="#cb81-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-75"><a href="#cb81-75" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-76"><a href="#cb81-76" aria-hidden="true" tabindex="-1"></a>san_diego <span class="op">=</span> san_diego.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>)</span>
<span id="cb81-77"><a href="#cb81-77" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-78"><a href="#cb81-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-81"><a href="#cb81-81" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-82"><a href="#cb81-82" aria-hidden="true" tabindex="-1"></a>f, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb81-83"><a href="#cb81-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-84"><a href="#cb81-84" aria-hidden="true" tabindex="-1"></a>san_diego.plot(<span class="st">'median_home_value'</span>, ax<span class="op">=</span>ax, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb81-85"><a href="#cb81-85" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax, crs<span class="op">=</span>san_diego.crs.to_string(), source<span class="op">=</span>cx.providers.CartoDB.Positron)</span>
<span id="cb81-86"><a href="#cb81-86" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">'off'</span>)</span>
<span id="cb81-87"><a href="#cb81-87" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-88"><a href="#cb81-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-91"><a href="#cb81-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-92"><a href="#cb81-92" aria-hidden="true" tabindex="-1"></a>san_diego.median_home_value.hist()</span>
<span id="cb81-93"><a href="#cb81-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-94"><a href="#cb81-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-97"><a href="#cb81-97" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-98"><a href="#cb81-98" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">12</span>))</span>
<span id="cb81-99"><a href="#cb81-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-100"><a href="#cb81-100" aria-hidden="true" tabindex="-1"></a>san_diego.dropna(subset<span class="op">=</span>[<span class="st">'median_home_value'</span>]).to_crs(epsg<span class="op">=</span><span class="dv">3857</span>).plot(<span class="st">'median_home_value'</span>, legend<span class="op">=</span><span class="va">True</span>, scheme<span class="op">=</span><span class="st">'quantiles'</span>, cmap<span class="op">=</span><span class="st">'GnBu'</span>, k<span class="op">=</span><span class="dv">5</span>, ax<span class="op">=</span>ax, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb81-101"><a href="#cb81-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-102"><a href="#cb81-102" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax, crs<span class="op">=</span>san_diego.crs.to_string(), source<span class="op">=</span>cx.providers.CartoDB.Positron)</span>
<span id="cb81-103"><a href="#cb81-103" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">'off'</span>)</span>
<span id="cb81-104"><a href="#cb81-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-105"><a href="#cb81-105" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Median Home Value (Quintiles)"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb81-106"><a href="#cb81-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-107"><a href="#cb81-107" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb81-108"><a href="#cb81-108" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb81-109"><a href="#cb81-109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-110"><a href="#cb81-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-111"><a href="#cb81-111" aria-hidden="true" tabindex="-1"></a><span class="fu">## Global Spatial Autocorrelation ##</span></span>
<span id="cb81-112"><a href="#cb81-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-113"><a href="#cb81-113" aria-hidden="true" tabindex="-1"></a>Visual inspection of the map pattern for the prices allows us to search for</span>
<span id="cb81-114"><a href="#cb81-114" aria-hidden="true" tabindex="-1"></a>spatial structure. If the spatial distribution of the prices was random, then we</span>
<span id="cb81-115"><a href="#cb81-115" aria-hidden="true" tabindex="-1"></a>should not see any clustering of similar values on the map. However, our visual</span>
<span id="cb81-116"><a href="#cb81-116" aria-hidden="true" tabindex="-1"></a>system is drawn to the darker clusters along the coast,</span>
<span id="cb81-117"><a href="#cb81-117" aria-hidden="true" tabindex="-1"></a>and a concentration of the lighter hues (lower prices) in the north central and</span>
<span id="cb81-118"><a href="#cb81-118" aria-hidden="true" tabindex="-1"></a>south east. In the point data, the trees are too dense to make any sense of the pattern</span>
<span id="cb81-119"><a href="#cb81-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-120"><a href="#cb81-120" aria-hidden="true" tabindex="-1"></a>Our brains are very powerful pattern recognition machines. However, sometimes</span>
<span id="cb81-121"><a href="#cb81-121" aria-hidden="true" tabindex="-1"></a>they can be too powerful and lead us to detect false positives, or patterns</span>
<span id="cb81-122"><a href="#cb81-122" aria-hidden="true" tabindex="-1"></a>where there are no statistical patterns. This is a particular concern when</span>
<span id="cb81-123"><a href="#cb81-123" aria-hidden="true" tabindex="-1"></a>dealing with visualization of irregular polygons of differning sizes and shapes.</span>
<span id="cb81-124"><a href="#cb81-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-125"><a href="#cb81-125" aria-hidden="true" tabindex="-1"></a>The concept of *spatial</span>
<span id="cb81-126"><a href="#cb81-126" aria-hidden="true" tabindex="-1"></a>autocorrelation* relates to the combination of two types of similarity: spatial</span>
<span id="cb81-127"><a href="#cb81-127" aria-hidden="true" tabindex="-1"></a>similarity and attribute similarity. Although there are many different measures</span>
<span id="cb81-128"><a href="#cb81-128" aria-hidden="true" tabindex="-1"></a>of spatial autocorrelation, they all combine these two types of simmilarity into</span>
<span id="cb81-129"><a href="#cb81-129" aria-hidden="true" tabindex="-1"></a>a summary measure.</span>
<span id="cb81-130"><a href="#cb81-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-131"><a href="#cb81-131" aria-hidden="true" tabindex="-1"></a>Let's use PySAL to generate these two types of similarity</span>
<span id="cb81-132"><a href="#cb81-132" aria-hidden="true" tabindex="-1"></a>measures.</span>
<span id="cb81-133"><a href="#cb81-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-134"><a href="#cb81-134" aria-hidden="true" tabindex="-1"></a><span class="fu">### Spatial Similarity ###</span></span>
<span id="cb81-135"><a href="#cb81-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-136"><a href="#cb81-136" aria-hidden="true" tabindex="-1"></a>We have already encountered spatial weights</span>
<span id="cb81-137"><a href="#cb81-137" aria-hidden="true" tabindex="-1"></a>in a previous notebook. In spatial autocorrelation analysis, the spatial weights</span>
<span id="cb81-138"><a href="#cb81-138" aria-hidden="true" tabindex="-1"></a>are used to formalize the notion of spatial similarity. As we have seen there</span>
<span id="cb81-139"><a href="#cb81-139" aria-hidden="true" tabindex="-1"></a>are many ways to define spatial weights, here we will use queen contiguity:</span>
<span id="cb81-140"><a href="#cb81-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-143"><a href="#cb81-143" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-144"><a href="#cb81-144" aria-hidden="true" tabindex="-1"></a>wq <span class="op">=</span>  lps.weights.Queen.from_dataframe(san_diego)</span>
<span id="cb81-145"><a href="#cb81-145" aria-hidden="true" tabindex="-1"></a>wq.transform <span class="op">=</span> <span class="st">'r'</span></span>
<span id="cb81-146"><a href="#cb81-146" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-147"><a href="#cb81-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-148"><a href="#cb81-148" aria-hidden="true" tabindex="-1"></a><span class="fu">### Attribute Similarity ###</span></span>
<span id="cb81-149"><a href="#cb81-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-150"><a href="#cb81-150" aria-hidden="true" tabindex="-1"></a>So the spatial weight between neighborhoods $i$ and $j$ indicates if the two </span>
<span id="cb81-151"><a href="#cb81-151" aria-hidden="true" tabindex="-1"></a>are neighbors (i.e., geographically similar). What we also need is a measure of</span>
<span id="cb81-152"><a href="#cb81-152" aria-hidden="true" tabindex="-1"></a>attribute similarity to pair up with this concept of spatial similarity. The</span>
<span id="cb81-153"><a href="#cb81-153" aria-hidden="true" tabindex="-1"></a>**spatial lag** is a derived variable that accomplishes this for us. For neighborhood</span>
<span id="cb81-154"><a href="#cb81-154" aria-hidden="true" tabindex="-1"></a>$i$ the spatial lag is defined as: $$ylag_i = \sum_j w_{i,j} y_j$$</span>
<span id="cb81-155"><a href="#cb81-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-158"><a href="#cb81-158" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-159"><a href="#cb81-159" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> san_diego[<span class="st">'median_home_value'</span>]</span>
<span id="cb81-160"><a href="#cb81-160" aria-hidden="true" tabindex="-1"></a>ylag <span class="op">=</span> lps.weights.lag_spatial(wq, y)</span>
<span id="cb81-161"><a href="#cb81-161" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-162"><a href="#cb81-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-165"><a href="#cb81-165" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-166"><a href="#cb81-166" aria-hidden="true" tabindex="-1"></a>f, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">12</span>))</span>
<span id="cb81-167"><a href="#cb81-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-168"><a href="#cb81-168" aria-hidden="true" tabindex="-1"></a>san_diego.assign(cl<span class="op">=</span>ylag).plot(column<span class="op">=</span><span class="st">'cl'</span>, scheme<span class="op">=</span><span class="st">'quantiles'</span>, <span class="op">\</span></span>
<span id="cb81-169"><a href="#cb81-169" aria-hidden="true" tabindex="-1"></a>        k<span class="op">=</span><span class="dv">5</span>, cmap<span class="op">=</span><span class="st">'GnBu'</span>, linewidth<span class="op">=</span><span class="fl">0.1</span>, ax<span class="op">=</span>ax, <span class="op">\</span></span>
<span id="cb81-170"><a href="#cb81-170" aria-hidden="true" tabindex="-1"></a>        edgecolor<span class="op">=</span><span class="st">'white'</span>, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb81-171"><a href="#cb81-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-172"><a href="#cb81-172" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax, crs<span class="op">=</span>san_diego.crs.to_string(), source<span class="op">=</span>cx.providers.CartoDB.Positron)</span>
<span id="cb81-173"><a href="#cb81-173" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">'off'</span>)</span>
<span id="cb81-174"><a href="#cb81-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-175"><a href="#cb81-175" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Spatial Lag Median Home Val (Quintiles)"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb81-176"><a href="#cb81-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-177"><a href="#cb81-177" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb81-178"><a href="#cb81-178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-179"><a href="#cb81-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-180"><a href="#cb81-180" aria-hidden="true" tabindex="-1"></a>The quintile map for the spatial lag tends to enhance the impression of value</span>
<span id="cb81-181"><a href="#cb81-181" aria-hidden="true" tabindex="-1"></a>similarity in space. It is, in effect, a local smoother.</span>
<span id="cb81-182"><a href="#cb81-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-185"><a href="#cb81-185" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-186"><a href="#cb81-186" aria-hidden="true" tabindex="-1"></a>san_diego[<span class="st">'lag_median_pri'</span>] <span class="op">=</span> ylag</span>
<span id="cb81-187"><a href="#cb81-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-188"><a href="#cb81-188" aria-hidden="true" tabindex="-1"></a>f,ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>,figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb81-189"><a href="#cb81-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-190"><a href="#cb81-190" aria-hidden="true" tabindex="-1"></a>san_diego.plot(column<span class="op">=</span><span class="st">'median_home_value'</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>],</span>
<span id="cb81-191"><a href="#cb81-191" aria-hidden="true" tabindex="-1"></a>        scheme<span class="op">=</span><span class="st">"quantiles"</span>,  k<span class="op">=</span><span class="dv">5</span>, cmap<span class="op">=</span><span class="st">'GnBu'</span>)</span>
<span id="cb81-192"><a href="#cb81-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-193"><a href="#cb81-193" aria-hidden="true" tabindex="-1"></a><span class="co">#ax[0].axis(san_diego.total_bounds[np.asarray([0,2,1,3])])</span></span>
<span id="cb81-194"><a href="#cb81-194" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Price"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb81-195"><a href="#cb81-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-196"><a href="#cb81-196" aria-hidden="true" tabindex="-1"></a>san_diego.plot(column<span class="op">=</span><span class="st">'lag_median_pri'</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>],</span>
<span id="cb81-197"><a href="#cb81-197" aria-hidden="true" tabindex="-1"></a>        scheme<span class="op">=</span><span class="st">'quantiles'</span>, cmap<span class="op">=</span><span class="st">'GnBu'</span>, k<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb81-198"><a href="#cb81-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-199"><a href="#cb81-199" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax[<span class="dv">0</span>], crs<span class="op">=</span>san_diego.crs.to_string(), source<span class="op">=</span>cx.providers.CartoDB.Positron)</span>
<span id="cb81-200"><a href="#cb81-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-201"><a href="#cb81-201" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax[<span class="dv">1</span>], crs<span class="op">=</span>san_diego.crs.to_string(), source<span class="op">=</span>cx.providers.CartoDB.Positron)</span>
<span id="cb81-202"><a href="#cb81-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-203"><a href="#cb81-203" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Spatial Lag Price"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb81-204"><a href="#cb81-204" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb81-205"><a href="#cb81-205" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb81-206"><a href="#cb81-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-207"><a href="#cb81-207" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb81-208"><a href="#cb81-208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-209"><a href="#cb81-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-210"><a href="#cb81-210" aria-hidden="true" tabindex="-1"></a>However, we still have</span>
<span id="cb81-211"><a href="#cb81-211" aria-hidden="true" tabindex="-1"></a>the challenge of visually associating the value of the prices in a neighborhod</span>
<span id="cb81-212"><a href="#cb81-212" aria-hidden="true" tabindex="-1"></a>with the value of the spatial lag of values for the focal unit. The latter is a</span>
<span id="cb81-213"><a href="#cb81-213" aria-hidden="true" tabindex="-1"></a>weighted average of home prices in the focal county's neighborhood.</span>
<span id="cb81-214"><a href="#cb81-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-215"><a href="#cb81-215" aria-hidden="true" tabindex="-1"></a>To complement the geovisualization of these associations we can turn to formal</span>
<span id="cb81-216"><a href="#cb81-216" aria-hidden="true" tabindex="-1"></a>statistical measures of spatial autocorrelation.</span>
<span id="cb81-217"><a href="#cb81-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-218"><a href="#cb81-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-219"><a href="#cb81-219" aria-hidden="true" tabindex="-1"></a><span class="fu">### Testing for Global Spatial Autocorrelation</span></span>
<span id="cb81-220"><a href="#cb81-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-221"><a href="#cb81-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-222"><a href="#cb81-222" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Join counts ####</span></span>
<span id="cb81-223"><a href="#cb81-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-224"><a href="#cb81-224" aria-hidden="true" tabindex="-1"></a>One way to formalize a test for spatial autocorrelation in a binary attribute is</span>
<span id="cb81-225"><a href="#cb81-225" aria-hidden="true" tabindex="-1"></a>to consider the so-called _joins_. A join exists for each neighbor pair of</span>
<span id="cb81-226"><a href="#cb81-226" aria-hidden="true" tabindex="-1"></a>observations, and the joins are reflected in our binary spatial weights object</span>
<span id="cb81-227"><a href="#cb81-227" aria-hidden="true" tabindex="-1"></a><span class="in">`wq`</span>. </span>
<span id="cb81-228"><a href="#cb81-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-229"><a href="#cb81-229" aria-hidden="true" tabindex="-1"></a>Each unit can take on one of two values "Black" or "White", analogous to the layout of a chessboard</span>
<span id="cb81-230"><a href="#cb81-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-233"><a href="#cb81-233" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-234"><a href="#cb81-234" aria-hidden="true" tabindex="-1"></a>nrows, ncols <span class="op">=</span> <span class="dv">9</span>,<span class="dv">9</span></span>
<span id="cb81-235"><a href="#cb81-235" aria-hidden="true" tabindex="-1"></a>image <span class="op">=</span> np.zeros(nrows<span class="op">*</span>ncols)</span>
<span id="cb81-236"><a href="#cb81-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-237"><a href="#cb81-237" aria-hidden="true" tabindex="-1"></a><span class="co"># Set every other cell to 1</span></span>
<span id="cb81-238"><a href="#cb81-238" aria-hidden="true" tabindex="-1"></a>image[::<span class="dv">2</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb81-239"><a href="#cb81-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-240"><a href="#cb81-240" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape things into a 9x9 grid.</span></span>
<span id="cb81-241"><a href="#cb81-241" aria-hidden="true" tabindex="-1"></a>image <span class="op">=</span> image.reshape((nrows, ncols))</span>
<span id="cb81-242"><a href="#cb81-242" aria-hidden="true" tabindex="-1"></a>plt.matshow(image, cmap<span class="op">=</span><span class="st">'Greys'</span>)</span>
<span id="cb81-243"><a href="#cb81-243" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb81-244"><a href="#cb81-244" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb81-245"><a href="#cb81-245" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-246"><a href="#cb81-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-247"><a href="#cb81-247" aria-hidden="true" tabindex="-1"></a>and so for a given</span>
<span id="cb81-248"><a href="#cb81-248" aria-hidden="true" tabindex="-1"></a>pair of neighboring locations there are three different types of joins that can</span>
<span id="cb81-249"><a href="#cb81-249" aria-hidden="true" tabindex="-1"></a>arise:</span>
<span id="cb81-250"><a href="#cb81-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-251"><a href="#cb81-251" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Black Black (BB)</span>
<span id="cb81-252"><a href="#cb81-252" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>White White (WW)</span>
<span id="cb81-253"><a href="#cb81-253" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Black White (or White Black) (BW)</span>
<span id="cb81-254"><a href="#cb81-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-255"><a href="#cb81-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-256"><a href="#cb81-256" aria-hidden="true" tabindex="-1"></a>We can use the <span class="in">`esda`</span> package from PySAL to carry out join count analysis. In the case of our point data, the join counts can help us determine whether different varieties of trees tend to grow together, spread randomly through space, or compete with one another for precious resources</span>
<span id="cb81-257"><a href="#cb81-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-258"><a href="#cb81-258" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Polygon Data</span></span>
<span id="cb81-259"><a href="#cb81-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-260"><a href="#cb81-260" aria-hidden="true" tabindex="-1"></a>With polygon data, we can conduct an analysis using a contiguity matrix. For our housing price data, we need to first discretize the variable we're using; to keep things simple, we'll binarize our price data using the median so that "high" values are tracts whose median home price is above the city's median and "low" values are those below</span>
<span id="cb81-261"><a href="#cb81-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-264"><a href="#cb81-264" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-265"><a href="#cb81-265" aria-hidden="true" tabindex="-1"></a>y.median()</span>
<span id="cb81-266"><a href="#cb81-266" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-267"><a href="#cb81-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-270"><a href="#cb81-270" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-271"><a href="#cb81-271" aria-hidden="true" tabindex="-1"></a>san_diego.shape</span>
<span id="cb81-272"><a href="#cb81-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-273"><a href="#cb81-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-276"><a href="#cb81-276" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-277"><a href="#cb81-277" aria-hidden="true" tabindex="-1"></a>yb <span class="op">=</span> y <span class="op">&gt;</span> y.median()</span>
<span id="cb81-278"><a href="#cb81-278" aria-hidden="true" tabindex="-1"></a><span class="bu">sum</span>(yb)</span>
<span id="cb81-279"><a href="#cb81-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-280"><a href="#cb81-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-283"><a href="#cb81-283" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-284"><a href="#cb81-284" aria-hidden="true" tabindex="-1"></a>yb <span class="op">=</span> y <span class="op">&gt;</span> y.median()</span>
<span id="cb81-285"><a href="#cb81-285" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">"0 Low"</span>, <span class="st">"1 High"</span>]</span>
<span id="cb81-286"><a href="#cb81-286" aria-hidden="true" tabindex="-1"></a>yb <span class="op">=</span> [labels[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">1</span><span class="op">*</span>yb] </span>
<span id="cb81-287"><a href="#cb81-287" aria-hidden="true" tabindex="-1"></a>san_diego[<span class="st">'yb'</span>] <span class="op">=</span> yb</span>
<span id="cb81-288"><a href="#cb81-288" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-289"><a href="#cb81-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-292"><a href="#cb81-292" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-293"><a href="#cb81-293" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">12</span>))</span>
<span id="cb81-294"><a href="#cb81-294" aria-hidden="true" tabindex="-1"></a>san_diego.plot(column<span class="op">=</span><span class="st">'yb'</span>, cmap<span class="op">=</span><span class="st">'binary'</span>, edgecolor<span class="op">=</span><span class="st">'grey'</span>, legend<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>ax)</span>
<span id="cb81-295"><a href="#cb81-295" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-296"><a href="#cb81-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-297"><a href="#cb81-297" aria-hidden="true" tabindex="-1"></a>The spatial distribution of the binary variable immediately raises questions</span>
<span id="cb81-298"><a href="#cb81-298" aria-hidden="true" tabindex="-1"></a>about the juxtaposition of the "black" and "white" areas.</span>
<span id="cb81-299"><a href="#cb81-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-300"><a href="#cb81-300" aria-hidden="true" tabindex="-1"></a>Given that we have 308 Black polygons on our map, what is the number of Black</span>
<span id="cb81-301"><a href="#cb81-301" aria-hidden="true" tabindex="-1"></a>Black (BB) joins we could expect if the process were such that the Black</span>
<span id="cb81-302"><a href="#cb81-302" aria-hidden="true" tabindex="-1"></a>polygons were randomly assigned on the map?</span>
<span id="cb81-303"><a href="#cb81-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-306"><a href="#cb81-306" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-307"><a href="#cb81-307" aria-hidden="true" tabindex="-1"></a>yb <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> (y <span class="op">&gt;</span> y.median()) <span class="co"># convert back to binary</span></span>
<span id="cb81-308"><a href="#cb81-308" aria-hidden="true" tabindex="-1"></a>wq <span class="op">=</span>  lps.weights.Queen.from_dataframe(san_diego)</span>
<span id="cb81-309"><a href="#cb81-309" aria-hidden="true" tabindex="-1"></a>wq.transform <span class="op">=</span> <span class="st">'b'</span></span>
<span id="cb81-310"><a href="#cb81-310" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">12345</span>)</span>
<span id="cb81-311"><a href="#cb81-311" aria-hidden="true" tabindex="-1"></a>jc <span class="op">=</span> esda.join_counts.Join_Counts(yb, wq)</span>
<span id="cb81-312"><a href="#cb81-312" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-313"><a href="#cb81-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-314"><a href="#cb81-314" aria-hidden="true" tabindex="-1"></a>The resulting object stores the observed counts for the different types of joins:</span>
<span id="cb81-315"><a href="#cb81-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-318"><a href="#cb81-318" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-319"><a href="#cb81-319" aria-hidden="true" tabindex="-1"></a>jc.bb</span>
<span id="cb81-320"><a href="#cb81-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-321"><a href="#cb81-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-324"><a href="#cb81-324" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-325"><a href="#cb81-325" aria-hidden="true" tabindex="-1"></a>jc.ww</span>
<span id="cb81-326"><a href="#cb81-326" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-327"><a href="#cb81-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-330"><a href="#cb81-330" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-331"><a href="#cb81-331" aria-hidden="true" tabindex="-1"></a>jc.bw</span>
<span id="cb81-332"><a href="#cb81-332" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-333"><a href="#cb81-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-334"><a href="#cb81-334" aria-hidden="true" tabindex="-1"></a>Note that the three cases exhaust all possibilities:</span>
<span id="cb81-335"><a href="#cb81-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-338"><a href="#cb81-338" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-339"><a href="#cb81-339" aria-hidden="true" tabindex="-1"></a>jc.bb <span class="op">+</span> jc.ww <span class="op">+</span> jc.bw</span>
<span id="cb81-340"><a href="#cb81-340" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-341"><a href="#cb81-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-342"><a href="#cb81-342" aria-hidden="true" tabindex="-1"></a>and</span>
<span id="cb81-343"><a href="#cb81-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-346"><a href="#cb81-346" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-347"><a href="#cb81-347" aria-hidden="true" tabindex="-1"></a>wq.s0 <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb81-348"><a href="#cb81-348" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-349"><a href="#cb81-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-350"><a href="#cb81-350" aria-hidden="true" tabindex="-1"></a>which is the unique number of joins in the spatial weights object.</span>
<span id="cb81-351"><a href="#cb81-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-352"><a href="#cb81-352" aria-hidden="true" tabindex="-1"></a>Our object tells us we have observed 736 BB joins:</span>
<span id="cb81-353"><a href="#cb81-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-356"><a href="#cb81-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-357"><a href="#cb81-357" aria-hidden="true" tabindex="-1"></a>jc.bb</span>
<span id="cb81-358"><a href="#cb81-358" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-359"><a href="#cb81-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-360"><a href="#cb81-360" aria-hidden="true" tabindex="-1"></a>The critical question for us, is whether this is a departure from what we would</span>
<span id="cb81-361"><a href="#cb81-361" aria-hidden="true" tabindex="-1"></a>expect if the process generating the spatial distribution of the Black polygons</span>
<span id="cb81-362"><a href="#cb81-362" aria-hidden="true" tabindex="-1"></a>were a completely random one? To answer this, PySAL uses random spatial</span>
<span id="cb81-363"><a href="#cb81-363" aria-hidden="true" tabindex="-1"></a>permutations of the observed attribute values to generate a realization under</span>
<span id="cb81-364"><a href="#cb81-364" aria-hidden="true" tabindex="-1"></a>the null of _complete spatial randomness_ (CSR). This is repeated a large number</span>
<span id="cb81-365"><a href="#cb81-365" aria-hidden="true" tabindex="-1"></a>of times (999 default) to construct a reference distribution to evaluate the</span>
<span id="cb81-366"><a href="#cb81-366" aria-hidden="true" tabindex="-1"></a>statistical significance of our observed counts.</span>
<span id="cb81-367"><a href="#cb81-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-368"><a href="#cb81-368" aria-hidden="true" tabindex="-1"></a>The average number of BB joins from the synthetic realizations is:</span>
<span id="cb81-369"><a href="#cb81-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-372"><a href="#cb81-372" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-373"><a href="#cb81-373" aria-hidden="true" tabindex="-1"></a>jc.mean_bb</span>
<span id="cb81-374"><a href="#cb81-374" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-375"><a href="#cb81-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-376"><a href="#cb81-376" aria-hidden="true" tabindex="-1"></a>which is less than our observed count. The question is whether our observed</span>
<span id="cb81-377"><a href="#cb81-377" aria-hidden="true" tabindex="-1"></a>value is so different from the expectation that we would reject the null of CSR?</span>
<span id="cb81-378"><a href="#cb81-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-381"><a href="#cb81-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-382"><a href="#cb81-382" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sbn</span>
<span id="cb81-383"><a href="#cb81-383" aria-hidden="true" tabindex="-1"></a>sbn.kdeplot(jc.sim_bb, shade<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb81-384"><a href="#cb81-384" aria-hidden="true" tabindex="-1"></a>plt.vlines(jc.bb, <span class="dv">0</span>, <span class="fl">0.005</span>, color<span class="op">=</span><span class="st">'r'</span>)</span>
<span id="cb81-385"><a href="#cb81-385" aria-hidden="true" tabindex="-1"></a>plt.vlines(jc.mean_bb, <span class="dv">0</span>,<span class="fl">0.005</span>)</span>
<span id="cb81-386"><a href="#cb81-386" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'BB Counts'</span>)</span>
<span id="cb81-387"><a href="#cb81-387" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-388"><a href="#cb81-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-389"><a href="#cb81-389" aria-hidden="true" tabindex="-1"></a>The density portrays the distribution of the BB counts, with the black vertical</span>
<span id="cb81-390"><a href="#cb81-390" aria-hidden="true" tabindex="-1"></a>line indicating the mean BB count from the synthetic realizations and the red</span>
<span id="cb81-391"><a href="#cb81-391" aria-hidden="true" tabindex="-1"></a>line the observed BB count for our prices. Clearly our observed value is</span>
<span id="cb81-392"><a href="#cb81-392" aria-hidden="true" tabindex="-1"></a>extremely high. A pseudo p-value summarizes this:</span>
<span id="cb81-393"><a href="#cb81-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-396"><a href="#cb81-396" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-397"><a href="#cb81-397" aria-hidden="true" tabindex="-1"></a>jc.p_sim_bb</span>
<span id="cb81-398"><a href="#cb81-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-399"><a href="#cb81-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-400"><a href="#cb81-400" aria-hidden="true" tabindex="-1"></a>Since this is below conventional significance levels, we would reject the null</span>
<span id="cb81-401"><a href="#cb81-401" aria-hidden="true" tabindex="-1"></a>of complete spatial randomness in favor of spatial autocorrelation in market prices.</span>
<span id="cb81-402"><a href="#cb81-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-403"><a href="#cb81-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-404"><a href="#cb81-404" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Continuous Case</span></span>
<span id="cb81-405"><a href="#cb81-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-406"><a href="#cb81-406" aria-hidden="true" tabindex="-1"></a>The join count analysis is based on a binary attribute, which can cover many</span>
<span id="cb81-407"><a href="#cb81-407" aria-hidden="true" tabindex="-1"></a>interesting empirical applications where one is interested in presence and</span>
<span id="cb81-408"><a href="#cb81-408" aria-hidden="true" tabindex="-1"></a>absence type phenomena. In our case, we artificially created the binary variable,</span>
<span id="cb81-409"><a href="#cb81-409" aria-hidden="true" tabindex="-1"></a>and in the process we throw away a lot of information in our originally</span>
<span id="cb81-410"><a href="#cb81-410" aria-hidden="true" tabindex="-1"></a>continuous attribute. Turning back to the original variable, we can explore</span>
<span id="cb81-411"><a href="#cb81-411" aria-hidden="true" tabindex="-1"></a>other tests for spatial autocorrelation for the continuous case.</span>
<span id="cb81-412"><a href="#cb81-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-413"><a href="#cb81-413" aria-hidden="true" tabindex="-1"></a>First, we transform our weights to be row-standardized, from the current binary state:</span>
<span id="cb81-414"><a href="#cb81-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-417"><a href="#cb81-417" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-418"><a href="#cb81-418" aria-hidden="true" tabindex="-1"></a>wq.transform <span class="op">=</span> <span class="st">'r'</span></span>
<span id="cb81-419"><a href="#cb81-419" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-420"><a href="#cb81-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-423"><a href="#cb81-423" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-424"><a href="#cb81-424" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> san_diego[<span class="st">'median_home_value'</span>]</span>
<span id="cb81-425"><a href="#cb81-425" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-426"><a href="#cb81-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-427"><a href="#cb81-427" aria-hidden="true" tabindex="-1"></a>Moran's I is a test for global autocorrelation for a continuous attribute:</span>
<span id="cb81-428"><a href="#cb81-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-431"><a href="#cb81-431" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-432"><a href="#cb81-432" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">12345</span>)</span>
<span id="cb81-433"><a href="#cb81-433" aria-hidden="true" tabindex="-1"></a>mi <span class="op">=</span> esda.moran.Moran(y, wq)</span>
<span id="cb81-434"><a href="#cb81-434" aria-hidden="true" tabindex="-1"></a>mi.I</span>
<span id="cb81-435"><a href="#cb81-435" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-436"><a href="#cb81-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-437"><a href="#cb81-437" aria-hidden="true" tabindex="-1"></a>Again, our value for the statistic needs to be interpreted against a reference</span>
<span id="cb81-438"><a href="#cb81-438" aria-hidden="true" tabindex="-1"></a>distribution under the null of CSR. PySAL uses a similar approach as we saw in</span>
<span id="cb81-439"><a href="#cb81-439" aria-hidden="true" tabindex="-1"></a>the join count analysis: random spatial permutations.</span>
<span id="cb81-440"><a href="#cb81-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-443"><a href="#cb81-443" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-444"><a href="#cb81-444" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> splot.esda <span class="im">import</span> plot_moran</span>
<span id="cb81-445"><a href="#cb81-445" aria-hidden="true" tabindex="-1"></a>plot_moran(mi, zstandard<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">4</span>))</span>
<span id="cb81-446"><a href="#cb81-446" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb81-447"><a href="#cb81-447" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-448"><a href="#cb81-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-451"><a href="#cb81-451" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-452"><a href="#cb81-452" aria-hidden="true" tabindex="-1"></a>mi.p_sim</span>
<span id="cb81-453"><a href="#cb81-453" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-454"><a href="#cb81-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-455"><a href="#cb81-455" aria-hidden="true" tabindex="-1"></a>On the left, we have the reference distribution versus the observed statistic; on the right, we have a plot of the focal value against its spatial lag, for which the Moran I statistic serves as the slope</span>
<span id="cb81-456"><a href="#cb81-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-457"><a href="#cb81-457" aria-hidden="true" tabindex="-1"></a>Here our observed value is again in the upper tail</span>
<span id="cb81-458"><a href="#cb81-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-461"><a href="#cb81-461" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-462"><a href="#cb81-462" aria-hidden="true" tabindex="-1"></a>mi.p_sim</span>
<span id="cb81-463"><a href="#cb81-463" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-464"><a href="#cb81-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-465"><a href="#cb81-465" aria-hidden="true" tabindex="-1"></a><span class="fu">## Local Autocorrelation: Hot Spots, Cold Spots, and Spatial Outliers ##</span></span>
<span id="cb81-466"><a href="#cb81-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-467"><a href="#cb81-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-468"><a href="#cb81-468" aria-hidden="true" tabindex="-1"></a>Local autocorrelation statistics provide indications of spatial autocorrelation</span>
<span id="cb81-469"><a href="#cb81-469" aria-hidden="true" tabindex="-1"></a>in a subset of the data. With $n$ observations, there are $n$ such subsets, with</span>
<span id="cb81-470"><a href="#cb81-470" aria-hidden="true" tabindex="-1"></a>each subset consisting of a *focal* unit together with the *neighbors* of the</span>
<span id="cb81-471"><a href="#cb81-471" aria-hidden="true" tabindex="-1"></a>focal unit.</span>
<span id="cb81-472"><a href="#cb81-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-473"><a href="#cb81-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-474"><a href="#cb81-474" aria-hidden="true" tabindex="-1"></a>PySAL has many local autocorrelation statistics. Let's compute a local Moran statistic for the same data</span>
<span id="cb81-475"><a href="#cb81-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-476"><a href="#cb81-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-477"><a href="#cb81-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-480"><a href="#cb81-480" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-481"><a href="#cb81-481" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">12345</span>)</span>
<span id="cb81-482"><a href="#cb81-482" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-483"><a href="#cb81-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-486"><a href="#cb81-486" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-487"><a href="#cb81-487" aria-hidden="true" tabindex="-1"></a>wq.transform <span class="op">=</span> <span class="st">'r'</span></span>
<span id="cb81-488"><a href="#cb81-488" aria-hidden="true" tabindex="-1"></a>lag_price <span class="op">=</span> lps.weights.lag_spatial(wq, san_diego[<span class="st">'median_home_value'</span>])</span>
<span id="cb81-489"><a href="#cb81-489" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-490"><a href="#cb81-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-493"><a href="#cb81-493" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-494"><a href="#cb81-494" aria-hidden="true" tabindex="-1"></a>li <span class="op">=</span> esda.moran.Moran_Local(y, wq)</span>
<span id="cb81-495"><a href="#cb81-495" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-496"><a href="#cb81-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-497"><a href="#cb81-497" aria-hidden="true" tabindex="-1"></a>Now, instead of a single $I$ statistic, we have an *array* of local $I_i$</span>
<span id="cb81-498"><a href="#cb81-498" aria-hidden="true" tabindex="-1"></a>statistics, stored in the <span class="in">`.Is`</span> attribute, and p-values from the simulation are</span>
<span id="cb81-499"><a href="#cb81-499" aria-hidden="true" tabindex="-1"></a>in <span class="in">`p_sim`</span>.</span>
<span id="cb81-500"><a href="#cb81-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-503"><a href="#cb81-503" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-504"><a href="#cb81-504" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> splot.esda <span class="im">import</span> moran_scatterplot</span>
<span id="cb81-505"><a href="#cb81-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-506"><a href="#cb81-506" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> moran_scatterplot(li)</span>
<span id="cb81-507"><a href="#cb81-507" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Price'</span>)</span>
<span id="cb81-508"><a href="#cb81-508" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Spatial Lag of Price'</span>)</span>
<span id="cb81-509"><a href="#cb81-509" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb81-510"><a href="#cb81-510" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-511"><a href="#cb81-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-512"><a href="#cb81-512" aria-hidden="true" tabindex="-1"></a>We can again test for local clustering using permutations, but here we use</span>
<span id="cb81-513"><a href="#cb81-513" aria-hidden="true" tabindex="-1"></a>conditional random permutations (different distributions for each focal location)</span>
<span id="cb81-514"><a href="#cb81-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-517"><a href="#cb81-517" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-518"><a href="#cb81-518" aria-hidden="true" tabindex="-1"></a>(li.p_sim <span class="op">&lt;</span> <span class="fl">0.05</span>).<span class="bu">sum</span>()</span>
<span id="cb81-519"><a href="#cb81-519" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-520"><a href="#cb81-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-523"><a href="#cb81-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-524"><a href="#cb81-524" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> moran_scatterplot(li, p<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb81-525"><a href="#cb81-525" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Price'</span>)</span>
<span id="cb81-526"><a href="#cb81-526" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Spatial Lag of Price'</span>)</span>
<span id="cb81-527"><a href="#cb81-527" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb81-528"><a href="#cb81-528" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-529"><a href="#cb81-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-530"><a href="#cb81-530" aria-hidden="true" tabindex="-1"></a>We can distinguish the specific type of local spatial association reflected in</span>
<span id="cb81-531"><a href="#cb81-531" aria-hidden="true" tabindex="-1"></a>the four quadrants of the Moran Scatterplot above:</span>
<span id="cb81-532"><a href="#cb81-532" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>High-High (upper right)</span>
<span id="cb81-533"><a href="#cb81-533" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Low-Low (bottom left)</span>
<span id="cb81-534"><a href="#cb81-534" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>High-Low (lower right)</span>
<span id="cb81-535"><a href="#cb81-535" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Low-High (upper left)</span>
<span id="cb81-536"><a href="#cb81-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-537"><a href="#cb81-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-538"><a href="#cb81-538" aria-hidden="true" tabindex="-1"></a>This information is encoded in the <span class="in">`q`</span> attribution of the Local Moran object:</span>
<span id="cb81-541"><a href="#cb81-541" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-542"><a href="#cb81-542" aria-hidden="true" tabindex="-1"></a>li.q</span>
<span id="cb81-543"><a href="#cb81-543" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-544"><a href="#cb81-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-545"><a href="#cb81-545" aria-hidden="true" tabindex="-1"></a><span class="fu">### Hot Spots</span></span>
<span id="cb81-546"><a href="#cb81-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-547"><a href="#cb81-547" aria-hidden="true" tabindex="-1"></a>The local statistic can be used to identify so-called "hot spots". To be a hot</span>
<span id="cb81-548"><a href="#cb81-548" aria-hidden="true" tabindex="-1"></a>spot, a focal unit has to satisfy two conditions:</span>
<span id="cb81-549"><a href="#cb81-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-550"><a href="#cb81-550" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It is in the High-High quadrant of the Moran Scatter Plot</span>
<span id="cb81-551"><a href="#cb81-551" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It has a statistically significant Local Moran </span>
<span id="cb81-552"><a href="#cb81-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-555"><a href="#cb81-555" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-556"><a href="#cb81-556" aria-hidden="true" tabindex="-1"></a>hotspot <span class="op">=</span> (li.p_sim <span class="op">&lt;</span> <span class="fl">0.05</span>) <span class="op">*</span> (li.q<span class="op">==</span><span class="dv">1</span>)</span>
<span id="cb81-557"><a href="#cb81-557" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span>hotspot<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> hot spots"</span>)</span>
<span id="cb81-558"><a href="#cb81-558" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-559"><a href="#cb81-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-560"><a href="#cb81-560" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cold Spots</span></span>
<span id="cb81-561"><a href="#cb81-561" aria-hidden="true" tabindex="-1"></a>A second type of positive local spatial autocorrelation occurs in the case of</span>
<span id="cb81-562"><a href="#cb81-562" aria-hidden="true" tabindex="-1"></a>"cold spots". To be a cold spot, a focal unit has to satisfy two conditions:</span>
<span id="cb81-563"><a href="#cb81-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-564"><a href="#cb81-564" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It is in the Low-Low quadrant of the Moran Scatter Plot</span>
<span id="cb81-565"><a href="#cb81-565" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It has a statistically significant Local Moran </span>
<span id="cb81-566"><a href="#cb81-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-567"><a href="#cb81-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-570"><a href="#cb81-570" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-571"><a href="#cb81-571" aria-hidden="true" tabindex="-1"></a>coldspot <span class="op">=</span> (li.p_sim <span class="op">&lt;</span> <span class="fl">0.05</span>) <span class="op">*</span> (li.q<span class="op">==</span><span class="dv">3</span>)</span>
<span id="cb81-572"><a href="#cb81-572" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span>coldspot<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> cold spots"</span>)</span>
<span id="cb81-573"><a href="#cb81-573" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-574"><a href="#cb81-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-575"><a href="#cb81-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-576"><a href="#cb81-576" aria-hidden="true" tabindex="-1"></a><span class="fu">### Spatial Outliers</span></span>
<span id="cb81-577"><a href="#cb81-577" aria-hidden="true" tabindex="-1"></a>While hot spots and cold spots reflect positive local spatial autocorrelation,</span>
<span id="cb81-578"><a href="#cb81-578" aria-hidden="true" tabindex="-1"></a>we know that another departure from spatial randomness can occur: negative</span>
<span id="cb81-579"><a href="#cb81-579" aria-hidden="true" tabindex="-1"></a>spatial autocorrelation. This is when the value dissimilarity between the focal</span>
<span id="cb81-580"><a href="#cb81-580" aria-hidden="true" tabindex="-1"></a>unit and those of its neighbors is larger than what could be due to random</span>
<span id="cb81-581"><a href="#cb81-581" aria-hidden="true" tabindex="-1"></a>chance.</span>
<span id="cb81-582"><a href="#cb81-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-583"><a href="#cb81-583" aria-hidden="true" tabindex="-1"></a>There are two types of spatial outliers.</span>
<span id="cb81-584"><a href="#cb81-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-585"><a href="#cb81-585" aria-hidden="true" tabindex="-1"></a>A doughnut (the kind with a hole) is a spatial outlier where the focal unit is</span>
<span id="cb81-586"><a href="#cb81-586" aria-hidden="true" tabindex="-1"></a>low, but the neighboring values are high. This would place the observation in</span>
<span id="cb81-587"><a href="#cb81-587" aria-hidden="true" tabindex="-1"></a>quadrant 2 of the scatter plot (LH). The position is a necessary, but not</span>
<span id="cb81-588"><a href="#cb81-588" aria-hidden="true" tabindex="-1"></a>sufficient, condition for being classified as a doughnut. The local Moran value</span>
<span id="cb81-589"><a href="#cb81-589" aria-hidden="true" tabindex="-1"></a>must also be statistically significant.</span>
<span id="cb81-590"><a href="#cb81-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-591"><a href="#cb81-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-594"><a href="#cb81-594" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-595"><a href="#cb81-595" aria-hidden="true" tabindex="-1"></a>doughnut <span class="op">=</span> (li.p_sim <span class="op">&lt;</span> <span class="fl">0.05</span>) <span class="op">*</span> (li.q<span class="op">==</span><span class="dv">2</span>)</span>
<span id="cb81-596"><a href="#cb81-596" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span>doughnut<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> doughnuts"</span>)</span>
<span id="cb81-597"><a href="#cb81-597" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-598"><a href="#cb81-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-599"><a href="#cb81-599" aria-hidden="true" tabindex="-1"></a>The second type of spatial outlier is the "diamond in the rough". Here the focal</span>
<span id="cb81-600"><a href="#cb81-600" aria-hidden="true" tabindex="-1"></a>value is high, but the neighboring values are low, and the local Moran value is</span>
<span id="cb81-601"><a href="#cb81-601" aria-hidden="true" tabindex="-1"></a>statistically significant:</span>
<span id="cb81-602"><a href="#cb81-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-603"><a href="#cb81-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-606"><a href="#cb81-606" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-607"><a href="#cb81-607" aria-hidden="true" tabindex="-1"></a>diamond <span class="op">=</span> (li.p_sim <span class="op">&lt;</span> <span class="fl">0.05</span>) <span class="op">*</span> (li.q<span class="op">==</span><span class="dv">4</span>)</span>
<span id="cb81-608"><a href="#cb81-608" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span>diamond<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> diamonds"</span>)</span>
<span id="cb81-609"><a href="#cb81-609" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-610"><a href="#cb81-610" aria-hidden="true" tabindex="-1"></a>In this case, we do not have any diamond observations, despite having</span>
<span id="cb81-611"><a href="#cb81-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-614"><a href="#cb81-614" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-615"><a href="#cb81-615" aria-hidden="true" tabindex="-1"></a>(li.q<span class="op">==</span><span class="dv">4</span>).<span class="bu">sum</span>()</span>
<span id="cb81-616"><a href="#cb81-616" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-617"><a href="#cb81-617" aria-hidden="true" tabindex="-1"></a>observations in the HL quadrant of the scatter plot.</span>
<span id="cb81-618"><a href="#cb81-618" aria-hidden="true" tabindex="-1"></a>In other words, all 44 of these observations have local statistics that are not</span>
<span id="cb81-619"><a href="#cb81-619" aria-hidden="true" tabindex="-1"></a>significantly different from their expectation under the null of spatial randomness.</span>
<span id="cb81-620"><a href="#cb81-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-621"><a href="#cb81-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-622"><a href="#cb81-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-623"><a href="#cb81-623" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cluster Map</span></span>
<span id="cb81-624"><a href="#cb81-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-625"><a href="#cb81-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-626"><a href="#cb81-626" aria-hidden="true" tabindex="-1"></a>Using <span class="in">`splot`</span>, we can also plot these hot spots, cold spots, and spatial outliers on the original geodataframe</span>
<span id="cb81-627"><a href="#cb81-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-630"><a href="#cb81-630" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-631"><a href="#cb81-631" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> splot.esda <span class="im">import</span> lisa_cluster</span>
<span id="cb81-632"><a href="#cb81-632" aria-hidden="true" tabindex="-1"></a>lisa_cluster(li, san_diego, p<span class="op">=</span><span class="fl">0.05</span>, figsize <span class="op">=</span> (<span class="dv">9</span>,<span class="dv">9</span>))</span>
<span id="cb81-633"><a href="#cb81-633" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb81-634"><a href="#cb81-634" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-635"><a href="#cb81-635" aria-hidden="true" tabindex="-1"></a>The cluster map displays the locations having a statistically significant LISA</span>
<span id="cb81-636"><a href="#cb81-636" aria-hidden="true" tabindex="-1"></a>value together with a label for the quadrant of the scatter plot. All other</span>
<span id="cb81-637"><a href="#cb81-637" aria-hidden="true" tabindex="-1"></a>locations are colored grey and labeled as "ns" (not significant). </span>
<span id="cb81-638"><a href="#cb81-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-639"><a href="#cb81-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-640"><a href="#cb81-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-641"><a href="#cb81-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-642"><a href="#cb81-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-645"><a href="#cb81-645" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-646"><a href="#cb81-646" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> splot.esda <span class="im">import</span> plot_local_autocorrelation</span>
<span id="cb81-647"><a href="#cb81-647" aria-hidden="true" tabindex="-1"></a>plot_local_autocorrelation(li, san_diego, <span class="st">'median_home_value'</span>)</span>
<span id="cb81-648"><a href="#cb81-648" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-649"><a href="#cb81-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-650"><a href="#cb81-650" aria-hidden="true" tabindex="-1"></a>Recall that we now have $n$ statistics, one for each location. This is in contrast to the case of global autocorrelation where there was one statistic for all $n$ locations. We can thus examine the statistical significance of any location with the local indicators:</span>
<span id="cb81-651"><a href="#cb81-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-652"><a href="#cb81-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-655"><a href="#cb81-655" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-656"><a href="#cb81-656" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">12345</span>)</span>
<span id="cb81-657"><a href="#cb81-657" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-658"><a href="#cb81-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-661"><a href="#cb81-661" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-662"><a href="#cb81-662" aria-hidden="true" tabindex="-1"></a>li <span class="op">=</span> esda.moran.Moran_Local(y, wq, keep_simulations<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb81-663"><a href="#cb81-663" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-664"><a href="#cb81-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-665"><a href="#cb81-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-668"><a href="#cb81-668" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-669"><a href="#cb81-669" aria-hidden="true" tabindex="-1"></a>li.p_sim[<span class="dv">626</span>]</span>
<span id="cb81-670"><a href="#cb81-670" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-671"><a href="#cb81-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-674"><a href="#cb81-674" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb81-675"><a href="#cb81-675" aria-hidden="true" tabindex="-1"></a>null <span class="op">=</span> li.sim[<span class="dv">626</span>]</span>
<span id="cb81-676"><a href="#cb81-676" aria-hidden="true" tabindex="-1"></a>observed <span class="op">=</span> li.Is[<span class="dv">626</span>]</span>
<span id="cb81-677"><a href="#cb81-677" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sbn</span>
<span id="cb81-678"><a href="#cb81-678" aria-hidden="true" tabindex="-1"></a>sbn.kdeplot(null, shade<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb81-679"><a href="#cb81-679" aria-hidden="true" tabindex="-1"></a>plt.vlines(observed,<span class="dv">0</span>, <span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'r'</span>)</span>
<span id="cb81-680"><a href="#cb81-680" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Local I for tract 626"</span>)</span>
<span id="cb81-681"><a href="#cb81-681" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-682"><a href="#cb81-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-683"><a href="#cb81-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-684"><a href="#cb81-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-685"><a href="#cb81-685" aria-hidden="true" tabindex="-1"></a><span class="fu">### A note on spatial clusters</span></span>
<span id="cb81-686"><a href="#cb81-686" aria-hidden="true" tabindex="-1"></a>It is important to note that only the focal units are symbolized on the cluster</span>
<span id="cb81-687"><a href="#cb81-687" aria-hidden="true" tabindex="-1"></a>map. Because the LISA tells us about the spatial association between the value</span>
<span id="cb81-688"><a href="#cb81-688" aria-hidden="true" tabindex="-1"></a>at the focal unit and the values in its neighboring units, the temptation is to</span>
<span id="cb81-689"><a href="#cb81-689" aria-hidden="true" tabindex="-1"></a>include the neighboring values together with the focal unit, if the latter is</span>
<span id="cb81-690"><a href="#cb81-690" aria-hidden="true" tabindex="-1"></a>significant. This would, however, be misleading in the case of a significant</span>
<span id="cb81-691"><a href="#cb81-691" aria-hidden="true" tabindex="-1"></a>focal unit who had neighbors, some of which had LISA values that were not significant.</span>
<span id="cb81-692"><a href="#cb81-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-693"><a href="#cb81-693" aria-hidden="true" tabindex="-1"></a>Instead, the focal unit with a significant LISA forms the seed of a</span>
<span id="cb81-694"><a href="#cb81-694" aria-hidden="true" tabindex="-1"></a>cluster. When it is contiguous to a different focal unit with a significant LISA</span>
<span id="cb81-695"><a href="#cb81-695" aria-hidden="true" tabindex="-1"></a>of the same form, the cluster will consist of multiple spatial units. Such a</span>
<span id="cb81-696"><a href="#cb81-696" aria-hidden="true" tabindex="-1"></a>connected component is a spatial cluster in the fullest sense.</span>
<span id="cb81-697"><a href="#cb81-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-698"><a href="#cb81-698" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{python} --&gt;</span></span>
<span id="cb81-699"><a href="#cb81-699" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- cluster_type = hotspot * 1 + doughnut * 2 + coldspot * 3 + diamond * 4 --&gt;</span></span>
<span id="cb81-700"><a href="#cb81-700" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- san_diego['cluster_type'] = cluster_type --&gt;</span></span>
<span id="cb81-701"><a href="#cb81-701" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- import libpysal --&gt;</span></span>
<span id="cb81-702"><a href="#cb81-702" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(libpysal.__version__) --&gt;</span></span>
<span id="cb81-703"><a href="#cb81-703" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- g = libpysal.graph.Graph.build_block_contiguity(san_diego.cluster_type) --&gt;</span></span>
<span id="cb81-704"><a href="#cb81-704" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(san_diego.shape, g.n) --&gt;</span></span>
<span id="cb81-705"><a href="#cb81-705" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- g.plot(san_diego) --&gt;</span></span>
<span id="cb81-706"><a href="#cb81-706" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb81-707"><a href="#cb81-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-708"><a href="#cb81-708" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{python} --&gt;</span></span>
<span id="cb81-709"><a href="#cb81-709" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- gq = libpysal.graph.Graph.build_contiguity(san_diego) --&gt;</span></span>
<span id="cb81-710"><a href="#cb81-710" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- gq.plot(san_diego) --&gt;</span></span>
<span id="cb81-711"><a href="#cb81-711" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb81-712"><a href="#cb81-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-713"><a href="#cb81-713" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{python} --&gt;</span></span>
<span id="cb81-714"><a href="#cb81-714" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- import networkx --&gt;</span></span>
<span id="cb81-715"><a href="#cb81-715" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- gnx = g.to_networkx() --&gt;</span></span>
<span id="cb81-716"><a href="#cb81-716" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- gqnx = g.to_networkx() --&gt;</span></span>
<span id="cb81-717"><a href="#cb81-717" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- inx = networkx.intersection(gnx, gqnx) --&gt;</span></span>
<span id="cb81-718"><a href="#cb81-718" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- cc = networkx.connected_components(inx) --&gt;</span></span>
<span id="cb81-719"><a href="#cb81-719" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- for i, component in enumerate(list(cc)): --&gt;</span></span>
<span id="cb81-720"><a href="#cb81-720" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     print(i, component) --&gt;</span></span>
<span id="cb81-721"><a href="#cb81-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-722"><a href="#cb81-722" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb81-723"><a href="#cb81-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-724"><a href="#cb81-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-725"><a href="#cb81-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-726"><a href="#cb81-726" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{python} --&gt;</span></span>
<span id="cb81-727"><a href="#cb81-727" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- li.Is.shape --&gt;</span></span>
<span id="cb81-728"><a href="#cb81-728" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb81-729"><a href="#cb81-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-730"><a href="#cb81-730" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{python} --&gt;</span></span>
<span id="cb81-731"><a href="#cb81-731" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- dir(li) --&gt;</span></span>
<span id="cb81-732"><a href="#cb81-732" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb81-733"><a href="#cb81-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-734"><a href="#cb81-734" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{python} --&gt;</span></span>
<span id="cb81-735"><a href="#cb81-735" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- dir(li) --&gt;</span></span>
<span id="cb81-736"><a href="#cb81-736" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb81-737"><a href="#cb81-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-738"><a href="#cb81-738" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{python} --&gt;</span></span>
<span id="cb81-739"><a href="#cb81-739" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- li.rlisas.shape --&gt;</span></span>
<span id="cb81-740"><a href="#cb81-740" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb81-741"><a href="#cb81-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-742"><a href="#cb81-742" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{python} --&gt;</span></span>
<span id="cb81-743"><a href="#cb81-743" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- li.rlisas[sig[0][-1],:] --&gt;</span></span>
<span id="cb81-744"><a href="#cb81-744" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb81-745"><a href="#cb81-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-746"><a href="#cb81-746" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{python} --&gt;</span></span>
<span id="cb81-747"><a href="#cb81-747" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- sig[0][-1] --&gt;</span></span>
<span id="cb81-748"><a href="#cb81-748" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb81-749"><a href="#cb81-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-750"><a href="#cb81-750" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{python} --&gt;</span></span>
<span id="cb81-751"><a href="#cb81-751" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- li.Is[626] --&gt;</span></span>
<span id="cb81-752"><a href="#cb81-752" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb81-753"><a href="#cb81-753" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>